<!DOCTYPE html><html lang="en-us"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="format-detection" content="email=no"><meta name="description" content="All things technical"><meta name="keywords" content="Blog"><title>ASP.Net Core 2.0 web api with multiple authentication - It Bloody Works</title><link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet"><link rel="stylesheet" href="/css/main_style.min.css"><link rel="icon" href="https://www.dropbox.com/s/yg6mmdlg0mh117y/favico.png?raw=1"><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-108227976-1"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-108227976-1');</script><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
  google_ad_client: "ca-pub-4797876414923413",
  enable_page_level_ads: true
});</script></head></html></script><body><input id="navi" type="checkbox"><ul class="main-navication"><li><a href="/"><span>Home</span></a></li><li><a href="https://twitter.com"><span>Twitter</span></a></li></ul><div class="wrapper" id="wrap"><div class="post-header"><label class="navi-button" for="navi">MENU</label><img class="background"><div class="post-title"><h1 class="title">ASP.Net Core 2.0 web api with multiple authentication</h1><ul class="meta"><li><i class="icon icon-author"></i>How to make things work</li><li><i class="icon icon-clock"></i>34 Minutes</li><li><i class="icon icon-calendar"></i>October 4, 2017</li></ul></div></div><div class="article-content" style="max-width:800px"><h2 id="Finding-up-to-date-information-on-how-to-create-a-ASP-Net-Core-2-0-secure-Web-Api-was-difficult-Here-is-a-recipe"><a href="#Finding-up-to-date-information-on-how-to-create-a-ASP-Net-Core-2-0-secure-Web-Api-was-difficult-Here-is-a-recipe" class="headerlink" title="Finding up-to-date information on how to create a ASP.Net Core 2.0 secure Web Api was difficult. Here is a recipe"></a><i>Finding up-to-date information on how to create a ASP.Net Core 2.0 secure Web Api was difficult. Here is a recipe</i></h2><a id="more"></a> 
<p>We’ll use Azure as the identity provider for this sample. Click <a href="https://portal.azure.com" target="_blank" rel="external"><em>here</em></a> to sign up for a free trial.</p>
<p>In this example we’ll create a web api and secure it for two purposes - one for human testing, and another for machine-to-machine communication.</p>
<p>The human testing part will use Azure Ad-integration and require a sign-in. Machine-to-machine will use <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/active-directory-v2-protocols-oauth-client-creds" target="_blank" rel="external"><em>OAuth 2 client credentials grant</em></a> for authentication. We’ll keep it simple.</p>
<h2 id="Register-an-app-you-will-use-for-authentication"><a href="#Register-an-app-you-will-use-for-authentication" class="headerlink" title="Register an app you will use for authentication"></a>Register an app you will use for authentication</h2><p>Go to <a href="https://apps.dev.microsoft.com" target="_blank" rel="external">https://apps.dev.microsoft.com</a>. Add an app under <em>Converged applications</em>, not Azure AD only. This makes the app available to the Azure v2 endpoint. Add an application secret as well, copy and paste this for later use.</p>
<video src="https://www.dropbox.com/s/uibr9z8vytz8g82/001_AppReg.mp4?raw=1#" autoplay controls><br>Sorry, your browser doesn’t support embedded videos<br></video>

<h2 id="Create-a-new-ASP-NET-core-2-0-Web-Api"><a href="#Create-a-new-ASP-NET-core-2-0-Web-Api" class="headerlink" title="Create a new ASP.NET core 2.0 Web Api"></a>Create a new ASP.NET core 2.0 Web Api</h2><p>Create a new ASP.NET Core Web Application:</p>
<p><img src="https://www.dropbox.com/s/n9pw4d7llc6g7lv/NewApi.PNG?raw=1" alt="New Api"></p>
<hr>

<p>Choose Web API with ASP.NET Core 2.0. Leave authentication off:</p>
<p><img src="https://www.dropbox.com/s/qd7lxxeonvo3wfe/NewApi_2.PNG?raw=1" alt="Choose Core 2.0"></p>
<hr>

<p>Extend the appSettings.json with the AzureAd-section below:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;Logging&quot;: &#123;</div><div class="line">    &quot;IncludeScopes&quot;: false,</div><div class="line">    &quot;Debug&quot;: &#123;</div><div class="line">      &quot;LogLevel&quot;: &#123;</div><div class="line">        &quot;Default&quot;: &quot;Warning&quot;</div><div class="line">      &#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;Console&quot;: &#123;</div><div class="line">      &quot;LogLevel&quot;: &#123;</div><div class="line">        &quot;Default&quot;: &quot;Warning&quot;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  &quot;AzureAd&quot;: &#123;</div><div class="line">    &quot;ClientId&quot;: &quot;952c3xxx-xxxx-xxx-xxx-xxxxxxxxxxxx&quot;,</div><div class="line">    &quot;AadInstance&quot;: &quot;https://login.microsoftonline.com/&#123;0&#125;&quot;,</div><div class="line">    &quot;TenantId&quot;: &quot;xxxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx&quot;,</div><div class="line">    &quot;PostLogoutRedirectUri&quot;: &quot;&quot;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Now  - the ClientId you find as the App ID in the app registration page on <a href="https://apps.dev.microsoft.com" target="_blank" rel="external">https://apps.dev.microsoft.com</a>:</p>
<p><hr><br><img src="https://www.dropbox.com/s/c6xst9mebjt2gl2/appsDevAppid.PNG?raw=1" alt="Find App Id"></p>
<hr>

<p>The tenant id you can find in the <a href="https://portal.azure.com" target="_blank" rel="external">Azure portal</a>. Search and select Azure Active Directory, and choose properties. The tenant id is the same as the Directory ID<br><img src="https://www.dropbox.com/s/c6symklfwxawhbt/azureportalTenantId.PNG?raw=1" alt="Find App Id"></p>
<p>After that, add the following nuget packages</p>
<ul>
<li>swashbuckle.aspnetcore.swaggergen</li>
<li>swashbuckle.aspnetcore.swaggerui</li>
</ul>
<p>We will use swagger to visualise and test our api. Our Api will be super simple - we’ll just reuse the ValuesController provided and change it to<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</div><div class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Authentication.Cookies;</div><div class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Authorization;</div><div class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Authentication.JwtBearer;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">MyApi.Controllers</span></div><div class="line">&#123;</div><div class="line">    [<span class="meta">Route(<span class="meta-string">"api/[controller]"</span>)</span>]</div><div class="line">    [<span class="meta">Authorize(AuthenticationSchemes = CookieAuthenticationDefaults.AuthenticationScheme + <span class="meta-string">","</span> + JwtBearerDefaults.AuthenticationScheme)</span>]</div><div class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ValuesController</span> : <span class="title">Controller</span></div><div class="line">    &#123;</div><div class="line">        [<span class="meta">HttpGet</span>]</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">Get</span>(<span class="params"></span>)</span></div><div class="line"><span class="function">        </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="string">"User: "</span> + (User.Identity.Name ?? <span class="string">"Authenticated client"</span>) ;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><br>We have added the Authorize-attribute and support two authentication schemas - Cookie and bearer token authentication. The only method this api exposes (/api/values) returns the user. If you have authenticated via Azure Ad, it will contain your username. If it is a client that has authenticated with a secret, the identity name will be empty.</p>
<p>So now we need to define how these two authentication schemes will work. At the same time we will configure swagger. Swagger is pretty awesome. It lets you document your services and facilitates means of testing them. Swagger uses xml-comments for documentation so in order to take full advantage of its possiblities, you should turn on xml-comments:</p>
<p><img src="https://www.dropbox.com/s/me6bfejexvl4kef/addXmlComment.PNG?raw=1" alt="Xml comments"></p>
<p>Change the startup.cs as follows:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Threading.Tasks;</div><div class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Builder;</div><div class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Hosting;</div><div class="line"><span class="keyword">using</span> Microsoft.Extensions.Configuration;</div><div class="line"><span class="keyword">using</span> Microsoft.Extensions.DependencyInjection;</div><div class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Authentication.Cookies;</div><div class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Authentication.OpenIdConnect;</div><div class="line"><span class="keyword">using</span> Microsoft.IdentityModel.Tokens;</div><div class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Authentication.JwtBearer;</div><div class="line"><span class="keyword">using</span> System.Diagnostics;</div><div class="line"><span class="keyword">using</span> Swashbuckle.AspNetCore.Swagger;</div><div class="line"><span class="keyword">using</span> Microsoft.Extensions.PlatformAbstractions;</div><div class="line"><span class="keyword">using</span> System.IO;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">MyApi</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Startup</span></div><div class="line">    &#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Startup</span>(<span class="params">IConfiguration configuration</span>)</span></div><div class="line"><span class="function">        </span>&#123;</div><div class="line">            Configuration = configuration;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> IConfiguration Configuration &#123; <span class="keyword">get</span>; &#125;</div><div class="line"></div><div class="line">        <span class="comment">// This method gets called by the runtime. Use this method to add services to the container.</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></div><div class="line"><span class="function">        </span>&#123;</div><div class="line">            services.AddMvc();</div><div class="line">            services.AddAuthentication(options =&gt;</div><div class="line">            &#123;</div><div class="line">                options.DefaultScheme = CookieAuthenticationDefaults.AuthenticationScheme;</div><div class="line">                options.DefaultChallengeScheme = OpenIdConnectDefaults.AuthenticationScheme;</div><div class="line">            &#125;)</div><div class="line">                 .AddJwtBearer(options =&gt;</div><div class="line">                 &#123;</div><div class="line">                     <span class="comment">// Add correct endpoint</span></div><div class="line">                     options.MetadataAddress = String.Format(Configuration[<span class="string">"AzureAd:AADInstance"</span>], Configuration[<span class="string">"AzureAd:TenantId"</span>]) + <span class="string">"/v2.0/.well-known/openid-configuration"</span>;</div><div class="line">                     options.Audience = Configuration[<span class="string">"AzureAD:ClientId"</span>];</div><div class="line"></div><div class="line">                     options.TokenValidationParameters =</div><div class="line">                                                <span class="keyword">new</span> TokenValidationParameters</div><div class="line">                                                &#123;</div><div class="line">                                                    ValidIssuer = <span class="string">$"https://sts.windows.net/<span class="subst">&#123;Configuration[<span class="string">"AzureAd:TenantId"</span>]&#125;</span>/"</span>,</div><div class="line">                                                    ValidAudience = <span class="string">"https://graph.microsoft.com"</span>,</div><div class="line">                                                &#125;;</div><div class="line"></div><div class="line">                     options.Events = <span class="keyword">new</span> JwtBearerEvents</div><div class="line">                     &#123;</div><div class="line">                         OnMessageReceived = context =&gt;</div><div class="line">                         &#123;</div><div class="line">                             <span class="keyword">return</span> Task.CompletedTask;</div><div class="line">                         &#125;,</div><div class="line">                         OnChallenge = context =&gt;</div><div class="line">                         &#123;</div><div class="line">                             <span class="keyword">return</span> Task.CompletedTask;</div><div class="line">                         &#125;,</div><div class="line">                         OnAuthenticationFailed = (context) =&gt;</div><div class="line">                         &#123;</div><div class="line">                             Console.WriteLine(<span class="string">"OnAuthenticationFailed: "</span> + context.Exception.Message);</div><div class="line"></div><div class="line">                             <span class="keyword">return</span> Task.CompletedTask;</div><div class="line">                             <span class="comment">//context.</span></div><div class="line">                         &#125;,</div><div class="line">                         OnTokenValidated = context =&gt;</div><div class="line">                         &#123;</div><div class="line">                             Console.WriteLine(<span class="string">"Validated: "</span> + context.SecurityToken);</div><div class="line">                             <span class="keyword">return</span> Task.CompletedTask;</div><div class="line">                         &#125;</div><div class="line">                     &#125;;</div><div class="line">                 &#125;)</div><div class="line">            .AddCookie()</div><div class="line">            .AddOpenIdConnect(option =&gt;</div><div class="line">            &#123;</div><div class="line">                option.ClientId = Configuration[<span class="string">"AzureAD:ClientId"</span>];</div><div class="line">                option.Authority = String.Format(Configuration[<span class="string">"AzureAd:AadInstance"</span>], Configuration[<span class="string">"AzureAd:TenantId"</span>]);</div><div class="line">                option.SignedOutRedirectUri = Configuration[<span class="string">"AzureAd:PostLogoutRedirectUri"</span>];</div><div class="line">                option.Events = <span class="keyword">new</span> OpenIdConnectEvents</div><div class="line">                &#123;</div><div class="line">                    OnRemoteFailure = context =&gt; &#123; context.HandleResponse(); Debug.WriteLine(context.Failure.Message); <span class="keyword">return</span> Task.FromResult(<span class="number">0</span>); &#125;</div><div class="line">                &#125;;</div><div class="line">            &#125;);</div><div class="line"></div><div class="line">            services.AddSwaggerGen(c =&gt;</div><div class="line">            &#123;</div><div class="line">                c.SwaggerDoc(<span class="string">"v1"</span>, <span class="keyword">new</span> Info</div><div class="line">                &#123;</div><div class="line">                    Title = <span class="string">"My Api sample"</span>,</div><div class="line">                    Version = <span class="string">"v1"</span>,</div><div class="line">                    Description = <span class="string">"Demonstrates two kinds of authentication"</span>,</div><div class="line">                    TermsOfService = <span class="string">"None"</span>,</div><div class="line"></div><div class="line">                &#125;);</div><div class="line"></div><div class="line">                <span class="keyword">var</span> basePath = PlatformServices.Default.Application.ApplicationBasePath;</div><div class="line">                <span class="keyword">var</span> xmlPath = Path.Combine(basePath, <span class="string">"MyApi.xml"</span>);</div><div class="line">                c.IncludeXmlComments(xmlPath);</div><div class="line"></div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">IApplicationBuilder app, IHostingEnvironment env</span>)</span></div><div class="line"><span class="function">        </span>&#123;</div><div class="line">            <span class="keyword">if</span> (env.IsDevelopment())</div><div class="line">            &#123;</div><div class="line">                app.UseDeveloperExceptionPage();</div><div class="line">            &#125;</div><div class="line">            app.UseSwagger();</div><div class="line">            app.UseSwaggerUI(c =&gt;</div><div class="line">            &#123;</div><div class="line">                c.SwaggerEndpoint(<span class="string">"/swagger/v1/swagger.json"</span>, <span class="string">"Test API"</span>);</div><div class="line"></div><div class="line">            &#125;);</div><div class="line">            app.UseAuthentication();</div><div class="line">            app.UseMvc();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>We’ll just add a default controller to trigger authentication and redirect to the swagger endpoint. Add HomeController.cs under the Controllers folder, and add this content</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</div><div class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Authorization;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">MyApi.Controllers</span></div><div class="line">&#123;</div><div class="line">    [<span class="meta">ApiExplorerSettings(IgnoreApi = true)</span>]</div><div class="line">    [<span class="meta">Authorize</span>]</div><div class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">HomeController</span> : <span class="title">Controller</span></div><div class="line">    &#123;</div><div class="line">        [<span class="meta">HttpGet(<span class="meta-string">""</span>)</span>]</div><div class="line">        <span class="function"><span class="keyword">public</span> ActionResult <span class="title">Index</span>(<span class="params"></span>)</span></div><div class="line"><span class="function">        </span>&#123;</div><div class="line">            <span class="keyword">return</span> Redirect(<span class="string">"~/swagger"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Testing"><a href="#Testing" class="headerlink" title="Testing"></a>Testing</h2><p>Now we are ready to start testing our application. There is one thing missing. If you run your api now, you will most likely run into an error page like this:</p>
<p><img src="https://www.dropbox.com/s/6gzwr4r88wyvpyt/ApiFirstRunNoReply.PNG?raw=1" alt="No reply"></p>
<p>To get rid of this you have to add a reply address. Go to <a href="https://apps.dev.microsoft.com" target="_blank" rel="external">https://apps.dev.microsoft.com</a> again and to your app. In the bottom of the page, select <em>Edit Application Manifest</em>.<br><img src="https://www.dropbox.com/s/kn9uc70bjsprnh9/EditAppmanifestPNG.PNG?raw=1" alt="Accept"></p>
<p>Add a value to replyUrls like this<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&quot;replyUrls&quot;: [&quot;http://localhost:57324/signin-oidc&quot;]</div></pre></td></tr></table></figure><br>but change the port to whatever port your app has been set to.</p>
<p>After you have saved your changes, run the application. After entering your credentials, you should see something like this screen:<br><img src="https://www.dropbox.com/s/23ftjxn28t6dj1f/ApiFirstRunAccept.PNG?raw=1" alt="Accept"><br>Accept and you should be redirected to /swagger:<br><img src="https://www.dropbox.com/s/4uaidlqi2mtsty3/NewApiFirstlook.PNG?raw=1" alt="Swagger"></p>
<p>You are will now access the Api with OpenId credentials. Your credentials are already stored as a cookie after signing in. Press “Try it out” and it should return your username:</p>
<p><img src="https://www.dropbox.com/s/x7ojwselwren822/NewApiTryout.PNG?raw=1" alt="Swagger tryout"></p>
<h2 id="Bearer-token-authntication"><a href="#Bearer-token-authntication" class="headerlink" title="Bearer token authntication"></a>Bearer token authntication</h2><p>To test the bearer token authentication, we’ll use a console application as the client.<br><img src="https://www.dropbox.com/s/hm9zh4dp0delsj0/NewTestClient.PNG?raw=1" alt="Console app">.<br>Add the following nuget-packages to the application</p>
<ul>
<li>Microsoft.Extensions.Configuration.Json</li>
<li>Microsoft.Identity.Client</li>
</ul>
<p>Also add a appSetting.json-file, set it to copy to output dir</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;ClientId&quot;: &quot;952cxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx&quot;,</div><div class="line">  &quot;AadInstance&quot;: &quot;https://login.microsoftonline.com/&#123;0&#125;&quot;,</div><div class="line">  &quot;TenantId&quot;: &quot;xxxxx-xxxx-xxxx-xxxx-xxx&quot;,</div><div class="line">  &quot;PostLogoutRedirectUri&quot;: &quot;&quot;,</div><div class="line">  &quot;Secret&quot;: &quot;EO4xxxxyyyyyzzzzzz&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ClientId and TenantId is the same as for the Api. The secret is from the first step of adding the application to<br><a href="https://apps.dev.microsoft.com" target="_blank" rel="external">https://apps.dev.microsoft.com</a> (see the video)</p>
<p>Change the Program.cs to<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System.Net;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">TestApp1</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">class</span> <span class="title">Program</span></div><div class="line">    &#123;</div><div class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span></div><div class="line"><span class="function">        </span>&#123;</div><div class="line">            <span class="keyword">var</span> builder = <span class="keyword">new</span> ConfigurationBuilder()</div><div class="line">              .AddJsonFile(<span class="string">"appSettings.json"</span>, optional: <span class="literal">false</span>, reloadOnChange: <span class="literal">true</span>);</div><div class="line">            <span class="keyword">var</span> config = builder.Build();</div><div class="line"></div><div class="line">            <span class="keyword">var</span> clientCredential = <span class="keyword">new</span> Microsoft.Identity.Client.ClientCredential(config[<span class="string">"Secret"</span>]);</div><div class="line"></div><div class="line">            <span class="keyword">var</span> redirecturi = <span class="string">"http://localhost:57324/"</span>;</div><div class="line"></div><div class="line">            <span class="keyword">var</span> clientApplication = <span class="keyword">new</span> Microsoft.Identity.Client.ConfidentialClientApplication(config[<span class="string">"ClientId"</span>], <span class="string">$"https://login.microsoftonline.com/<span class="subst">&#123;config[<span class="string">"TenantId"</span>]&#125;</span>"</span>, redirecturi, clientCredential, <span class="literal">null</span>, <span class="literal">null</span>);</div><div class="line">            <span class="keyword">var</span> authenticationResult = clientApplication.AcquireTokenForClientAsync(<span class="keyword">new</span> []&#123; <span class="string">"https://graph.microsoft.com/.default"</span> &#125;).Result;</div><div class="line"></div><div class="line">            <span class="keyword">var</span> client = <span class="keyword">new</span> WebClient();</div><div class="line">            client.Headers.Add(<span class="string">"Authorization"</span>, <span class="string">"Bearer "</span> + authenticationResult.AccessToken);</div><div class="line">            <span class="keyword">var</span> responseFromApi = client.DownloadString(<span class="string">"http://localhost:57324/api/values"</span>);</div><div class="line">            Debug.WriteLine(responseFromApi);</div><div class="line"></div><div class="line">            </div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>And there you go - run the sample and you should get “User: Authenticated client” as the result.</p>
<!-- regalaroso@ququb.com -->
</div><div class="article-meta" style="max-width:800px"><div class="tags"><i class="icon icon-tag"></i><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ASP-NET-Core-2-0/">ASP.NET Core 2.0</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Security/">Security</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Swagger/">Swagger</a><span class="tag-list-count">1</span></li></ul></div></div><ul class="navication"><li class="home"><a href="/"><i class="icon icon-home"></i></a></li></ul><div class="page-footer"><div class="top"><ul class="social"><li><a href="mailto:contact@itbloodyworks.com" title="EMail" target="_blank"><i class="icon icon-email"></i></a></li><li><a href="https://twitter.com" title="Twitter" target="_blank"><i class="icon icon-twitter"></i></a></li></ul></div><div class="bottom"><p class="copyright">© 2017 It Bloody Works</p></div></div></div><script>var wrap = document.getElementById('wrap');
window.onload = function () {
  wrap.className += ' done';
}</script></body>